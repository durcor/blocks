#!/bin/sh

# Common distributed computing binaries:
# - boinc-client
# - foldingathome

if systemctl is-enabled boinc-client>/dev/null; then
    dist_prj=""
    perm_level="sudo systemctl"
    project_command=boinc-client
elif systemctl --user is-enabled foldingathome>/dev/null; then
    dist_prj=""
    project_command=foldingathome
    perm_level="systemctl --user"
    status_command(){
        notify-send \
            -i ~/.local/bin/i3blocks/img/f@h.png \
            -h string:x-canonical-private-synchronous:i3bdistcompute \
            "F@H Status" "$(tail ~/.config/fah/log.txt)"
    }
else
    exit
fi

case $BLOCK_BUTTON in
    # Left Click
    1) 
    status_command
    ;;
    # Middle Click
	2) 
    if $perm_level is-active $project_command >/dev/null; then
        notify-send \
            -i ~/.local/bin/i3blocks/img/f@h.png \
            -h string:x-canonical-private-synchronous:i3bdistcompute \
            "Stopping $project_command"

        $perm_level stop $project_command

        notify-send \
            -i ~/.local/bin/i3blocks/img/f@h.png \
            -h string:x-canonical-private-synchronous:i3bdistcompute \
            "$project_command stopped"
    else
        notify-send \
            -i ~/.local/bin/i3blocks/img/f@h.png \
            -h string:x-canonical-private-synchronous:i3bdistcompute \
            "Starting $project_command"

        $perm_level start $project_command

        notify-send \
            -i ~/.local/bin/i3blocks/img/f@h.png \
            -h string:x-canonical-private-synchronous:i3bdistcompute \
            "$project_command started"
    fi
    ;;
    # Right Click
    3) 
    xdg-open http://localhost:7396
    ;;
    # Scroll Up
    4);;
    # Scroll Down
    5);;
    # Rear Side Button
    8)
    xdg-open http://localhost:7396
    ;;
    # Front Side Button
    9)
    xdg-open http://localhost:7396
    ;;
esac

#  - telescope
#  - molecule
#  - microscope
#  - pill
#  - biohazard
#  - atom

if [ "$project_command" = "boinc-client" ]; then
    return
else
    # TODO: Use switch case
    if tail -n1 ~/.config/fah/log.txt | grep 'Except\|exit' >/dev/null;then
        block_out=""
    elif tail -n1 ~/.config/fah/log.txt | grep 'Complete' >/dev/null;then
        block_out="$(tail -n1 ~/.config/fah/log.txt | awk '{print $7}')"
    elif tail -n1 ~/.config/fah/log.txt | grep 'Temperature\|Web' >/dev/null;then
        block_out="$(tail -n20 ~/.config/fah/log.txt | grep 'Complete' | tail -n1 | awk '{print $7}')"
    elif tail -n1 ~/.config/fah/log.txt | grep 'checkpoint' >/dev/null;then
        block_out=""
    elif tail -n1 ~/.config/fah/log.txt | grep 'Download' >/dev/null;then
        block_out=""
    elif tail -n1 ~/.config/fah/log.txt | grep 'Upload' >/dev/null;then
        block_out=""
    else
        block_out=""
    fi
fi

echo "$dist_prj  $block_out "
